

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="wangcw">
  <meta name="keywords" content="">
  
    <meta name="description" content="应用1 壹好车服定位数据新增专用账号123ALTER USER root PASS &amp;#x27;Lunz2017&amp;#x27;;CREATE USER user_service PASS &amp;#x27;Lunz2017&amp;#x27;;ALTER USER user_service PRIVILEGE write;  建库1CREATE DATABASE IF NOT EXISTS locationcen">
<meta property="og:type" content="article">
<meta property="og:title" content="TDEngine应用测试">
<meta property="og:url" content="https://blog.wongcw.cn/2022/06/02/TDEngine%E5%BA%94%E7%94%A8%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="blogwong">
<meta property="og:description" content="应用1 壹好车服定位数据新增专用账号123ALTER USER root PASS &amp;#x27;Lunz2017&amp;#x27;;CREATE USER user_service PASS &amp;#x27;Lunz2017&amp;#x27;;ALTER USER user_service PRIVILEGE write;  建库1CREATE DATABASE IF NOT EXISTS locationcen">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picwong.oss-cn-qingdao.aliyuncs.com/zr.wongcw/202206231714349.png">
<meta property="article:published_time" content="2022-06-02T09:23:11.000Z">
<meta property="article:modified_time" content="2022-06-28T02:21:14.000Z">
<meta property="article:author" content="wangcw">
<meta property="article:tag" content="TDEngine">
<meta property="article:tag" content="时序数据库">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://picwong.oss-cn-qingdao.aliyuncs.com/zr.wongcw/202206231714349.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>TDEngine应用测试 - blogwong</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.wongcw.cn","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"663d1a6ec35b55e9fe6afb524ef4adaf","google":"GTM-T9V396Z","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?663d1a6ec35b55e9fe6afb524ef4adaf";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'GTM-T9V396Z', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>blogwong</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="TDEngine应用测试"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-06-02 17:23" pubdate>
          2022年6月2日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          51k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          428 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">TDEngine应用测试</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="应用1-壹好车服定位数据"><a href="#应用1-壹好车服定位数据" class="headerlink" title="应用1 壹好车服定位数据"></a>应用1 壹好车服定位数据</h2><h4 id="新增专用账号"><a href="#新增专用账号" class="headerlink" title="新增专用账号"></a>新增专用账号</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> root PASS <span class="hljs-string">&#x27;Lunz2017&#x27;</span>;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> user_service PASS <span class="hljs-string">&#x27;Lunz2017&#x27;</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> user_service PRIVILEGE write;<br></code></pre></td></tr></table></figure>

<h4 id="建库"><a href="#建库" class="headerlink" title="建库"></a>建库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> locationcenter <span class="hljs-keyword">UPDATE</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<p>参数解析</p>
<blockquote>
<h5 id="INFO"><a href="#INFO" class="headerlink" title="INFO"></a>INFO</h5><ol>
<li><p>KEEP 是该数据库的数据保留多长天数，缺省是 3650 天(10 年)，数据库会自动删除超过时限的数据；</p>
</li>
<li><p>UPDATE 标志数据库支持更新相同时间戳数据；（从 2.1.7.0 版本开始此参数支持设为 2，表示允许部分列更新，也即更新数据行时未被设置的列会保留原值。）（从 2.0.8.0 版本开始支持此参数。注意此参数不能通过<code>ALTER DATABASE</code>指令进行修改。）</p>
<ol>
<li>UPDATE 设为 0 时，表示不允许更新数据，后发送的相同时间戳的数据会被直接丢弃；</li>
<li>UPDATE 设为 1 时，表示更新全部列数据，即如果更新一个数据行，其中某些列没有提供取值，那么这些列会被设为 NULL；</li>
<li>UPDATE 设为 2 时，表示支持更新部分列数据，即如果更新一个数据行，其中某些列没有提供取值，那么这些列会保持原有数据行中的对应值；</li>
<li>更多关于 UPDATE 参数的用法，请参考<a target="_blank" rel="noopener" href="https://docs.taosdata.com/train-faq/faq">FAQ</a>。</li>
</ol>
</li>
<li><p>数据库名最大长度为 33；</p>
</li>
<li><p>一条 SQL 语句的最大长度为 65480 个字符；</p>
</li>
<li><p>创建数据库时可用的参数有：</p>
<ul>
<li>cache: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#cache">详细说明</a></li>
<li>blocks: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#blocks">详细说明</a></li>
<li>days: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#days">详细说明</a></li>
<li>keep: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#keep">详细说明</a></li>
<li>minRows: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#minrows">详细说明</a></li>
<li>maxRows: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#maxrows">详细说明</a></li>
<li>wal: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#wallevel">详细说明</a></li>
<li>fsync: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#fsync">详细说明</a></li>
<li>update: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#update">详细说明</a></li>
<li>cacheLast: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#cachelast">详细说明</a></li>
<li>replica: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#replica">详细说明</a></li>
<li>quorum: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#quorum">详细说明</a></li>
<li>maxVgroupsPerDb: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#maxvgroupsperdb">详细说明</a></li>
<li>comp: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#comp">详细说明</a></li>
<li>precision: <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/#precision">详细说明</a></li>
</ul>
</li>
<li><p>请注意上面列出的所有参数都可以配置在配置文件 <code>taosd.cfg</code> 中作为创建数据库时使用的默认配置， <code>create database</code> 的参数中明确指定的会覆盖配置文件中的设置。</p>
</li>
</ol>
</blockquote>
<p>显示当前参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> VARIABLES;<br></code></pre></td></tr></table></figure>

<p>设置压缩值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter COMP <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>COMP 参数是指修改数据库文件压缩标志位，缺省值为 2，取值范围为 [0, 2]。0 表示不压缩，1 表示一阶段压缩，2 表示两阶段压缩。</p>
</blockquote>
<p>设置副本数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter REPLICA <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>REPLICA 参数是指修改数据库副本数，取值范围 [1, 3]。在集群中使用，副本数必须小于或等于 DNODE 的数目。</p>
</blockquote>
<p>设置保留天数参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter KEEP <span class="hljs-number">365000</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>KEEP 参数是指修改数据文件保存的天数，缺省值为 3650，取值范围 [days, 365000]，必须大于或等于 days 参数值。查看参数时有的话默认就行</p>
</blockquote>
<p>设置块大小</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter BLOCKS <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>BLOCKS 参数是每个 VNODE (TSDB) 中有多少 cache 大小的内存块，因此一个 VNODE 的用的内存大小粗略为（cache * blocks）。取值范围 [3, 1000]。</p>
</blockquote>
<p>设置确认数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter QUORUM <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>QUORUM 参数是指数据写入成功所需要的确认数，取值范围 [1, 2]。对于异步复制，quorum 设为 1，具有 master 角色的虚拟节点自己确认即可。对于同步复制，quorum 设为 2。原则上，Quorum &gt;= 1 并且 Quorum &lt;= replica(副本数)，这个参数在启动一个同步模块实例时需要提供。</p>
</blockquote>
<p>设置缓存</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> DATABASE locationcenter CACHELAST <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>CACHELAST 参数控制是否在内存中缓存子表的最近数据。缺省值为 0，取值范围 [0, 1, 2, 3]。其中 0 表示不缓存，1 表示缓存子表最近一行数据，2 表示缓存子表每一列的最近的非 NULL 值，3 表示同时打开缓存最近行和列功能。（从 2.0.11.0 版本开始支持参数值 [0, 1]，从 2.1.2.0 版本开始支持参数值 [0, 1, 2, 3]。）<br>说明：缓存最近行，将显著改善 LAST_ROW 函数的性能表现；缓存每列的最近非 NULL 值，将显著改善无特殊影响（WHERE、ORDER BY、GROUP BY、INTERVAL）下的 LAST 函数的性能表现。</p>
</blockquote>
<p>显示所有数据库及设置参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> DATABASES;<br><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> DATABASE locationcenter\G;<br></code></pre></td></tr></table></figure>

<p>服务器参数优化参考 <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/config/">https://docs.taosdata.com/reference/config/</a></p>
<p>taos服务和taosadapter参数配置，dnode添加删除，mnode数量配置，vnode表数量多少，表在vnode分布，vnode在dnode上的分布调整。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/380778972">https://zhuanlan.zhihu.com/p/380778972</a></p>
<p>taosadapter生产环境参数，需要修改日志记录级别，修改日志记录位置（放数据盘）。</p>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><p>实际场景解释：创建超级表，为模板表，根据实际业务，壹号车服app使用人员3000-4000人，数据写入时根据人员登录Code分不同子表存储数据，这样取数据时会每个人只从一个单子表里取值，且数据库参数CACHELAST设置为3后，每个人最新一次定位直接从缓存获取，大大加快查询速度。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">USE `locationcenter`;<br><span class="hljs-keyword">DROP</span> STABLE IF <span class="hljs-keyword">EXISTS</span> `userlocation`;<br><span class="hljs-keyword">CREATE</span> STABLE `userlocation` <br>(`locationtime` <span class="hljs-type">TIMESTAMP</span>,<br> `loginname` <span class="hljs-type">NCHAR</span>(<span class="hljs-number">50</span>),<br> `lat` <span class="hljs-keyword">DOUBLE</span>,<br> `lng` <span class="hljs-keyword">DOUBLE</span>,<br> `speed` <span class="hljs-keyword">DOUBLE</span>,<br> `address` <span class="hljs-type">NCHAR</span>(<span class="hljs-number">200</span>)) <br> TAGS (`username` <span class="hljs-type">NCHAR</span>(<span class="hljs-number">50</span>),<br>       `deviceimei` <span class="hljs-type">NCHAR</span>(<span class="hljs-number">50</span>),<br>       `devicemodel` <span class="hljs-type">NCHAR</span>(<span class="hljs-number">100</span>),<br>       `devicetype` BOOL);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>说明</p>
<ol>
<li>表的第一个字段必须是 TIMESTAMP，并且系统自动将其设为主键；</li>
<li>表名最大长度为 192；</li>
<li>表的每行长度不能超过 48KB;（注意：每个 BINARY/NCHAR 类型的列还会额外占用 2 个字节的存储位置）；</li>
<li>子表名只能由字母、数字和下划线组成，且不能以数字开头，不区分大小写；</li>
<li>使用数据类型 binary 或 nchar，需指定其最长的字节数，如 binary(20)，表示 20 字节；</li>
<li>为了兼容支持更多形式的表名，TDengine 引入新的转义符 “<code>&quot;，可以让表名与关键词不冲突，同时不受限于上述表名称合法性约束检查。但是同样具有长度限制要求。使用转义字符以后，不再对转义字符中的内容进行大小写统一。 例如：</code>aBc<code>和</code>abc` 是不同的表名，但是 abc 和 aBc 是相同的表名。 需要注意的是转义字符中的内容必须是可打印字符。 上述的操作逻辑和约束要求与 MySQL 数据的操作一致。 从 2.3.0.0 版本开始支持这种方式；</li>
<li>数据迁移注意保障列长足够，表的第一个字段可以使用UNIX_TIMESTAMP格式写入，根据库的时间经度自动转换；</li>
<li>TAGS 列的数据类型不能是 timestamp 类型；（从 2.1.3.0 版本开始，TAGS 列中支持使用 timestamp 类型，但需注意在 TAGS 中的 timestamp 列写入数据时需要提供给定值，而暂不支持四则运算，例如 <code>NOW + 10s</code> 这类表达式）</li>
<li>TAGS 列名不能与其他列名相同；</li>
<li>TAGS 列名不能为预留关键字（参见：<a target="_blank" rel="noopener" href="https://docs.taosdata.com/taos-sql/keywords/">参数限制与保留关键字</a> 章节）；</li>
<li>TAGS 最多允许 128 个，至少 1 个，总长度不超过 16 KB。</li>
</ol>
</blockquote>
<p>支持无模式表数据写入，兼容 InfluxDB 的 行协议（Line Protocol）、OpenTSDB 的 telnet 行协议、OpenTSDB 的 JSON 格式协议。</p>
<p>介绍：<a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/schemaless/">https://docs.taosdata.com/reference/schemaless/</a></p>
<p>如表列不定，随时增加可使用此模式。</p>
<p>支持的数据</p>
<table>
<thead>
<tr>
<th>#</th>
<th><strong>类型</strong></th>
<th><strong>Bytes</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>TIMESTAMP</td>
<td>8</td>
<td>时间戳。缺省精度毫秒，可支持微秒和纳秒。从格林威治时间 1970-01-01 00:00:00.000 (UTC/GMT) 开始，计时不能早于该时间。（从 2.0.18.0 版本开始，已经去除了这一时间范围限制）（从 2.1.5.0 版本开始支持纳秒精度）</td>
</tr>
<tr>
<td>2</td>
<td>INT</td>
<td>4</td>
<td>整型，范围 [-2^31+1, 2^31-1], -2^31 用作 NULL</td>
</tr>
<tr>
<td>3</td>
<td>BIGINT</td>
<td>8</td>
<td>长整型，范围 [-2^63+1, 2^63-1], -2^63 用作 NULL</td>
</tr>
<tr>
<td>4</td>
<td>FLOAT</td>
<td>4</td>
<td>浮点型，有效位数 6-7，范围 [-3.4E38, 3.4E38]</td>
</tr>
<tr>
<td>5</td>
<td>DOUBLE</td>
<td>8</td>
<td>双精度浮点型，有效位数 15-16，范围 [-1.7E308, 1.7E308]</td>
</tr>
<tr>
<td>6</td>
<td>BINARY</td>
<td>自定义</td>
<td>记录单字节字符串，建议只用于处理 ASCII 可见字符，中文等多字节字符需使用 nchar。理论上，最长可以有 16374 字节。binary 仅支持字符串输入，字符串两端需使用单引号引用。使用时须指定大小，如 binary(20) 定义了最长为 20 个单字节字符的字符串，每个字符占 1 byte 的存储空间，总共固定占用 20 bytes 的空间，此时如果用户字符串超出 20 字节将会报错。对于字符串内的单引号，可以用转义字符反斜线加单引号来表示，即 <code>\’</code>。</td>
</tr>
<tr>
<td>7</td>
<td>SMALLINT</td>
<td>2</td>
<td>短整型， 范围 [-32767, 32767], -32768 用作 NULL</td>
</tr>
<tr>
<td>8</td>
<td>TINYINT</td>
<td>1</td>
<td>单字节整型，范围 [-127, 127], -128 用作 NULL</td>
</tr>
<tr>
<td>9</td>
<td>BOOL</td>
<td>1</td>
<td>布尔型，{true, false}</td>
</tr>
<tr>
<td>10</td>
<td>NCHAR</td>
<td>自定义</td>
<td>记录包含多字节字符在内的字符串，如中文字符。每个 nchar 字符占用 4 bytes 的存储空间。字符串两端使用单引号引用，字符串内的单引号需用转义字符 <code>\’</code>。nchar 使用时须指定字符串大小，类型为 nchar(10) 的列表示此列的字符串最多存储 10 个 nchar 字符，会固定占用 40 bytes 的空间。如果用户字符串长度超出声明长度，将会报错。</td>
</tr>
<tr>
<td>11</td>
<td>JSON</td>
<td></td>
<td>json 数据类型， 只有 tag 可以是 json 格式</td>
</tr>
</tbody></table>
<p>显示建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> userlocation\G;<br><span class="hljs-keyword">DESCRIBE</span> userlocation;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意：查询超级表时对表描述词要改为 STABLE。</p>
<p>例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SHOW</span> TABLES;<br><span class="hljs-keyword">SHOW</span> STABLES;<br><span class="hljs-keyword">DROP</span> STABLE XX;<br></code></pre></td></tr></table></figure>
</blockquote>
<p>表字段操作同MySQL，表标签相关管理：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">#修改子表标签<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> userlocation <span class="hljs-keyword">SET</span> TAG loginname<span class="hljs-operator">=</span>loginname;<br>#添加超级表标签<br><span class="hljs-keyword">ALTER</span> STABLE userlocation <span class="hljs-keyword">ADD</span> TAG testtag <span class="hljs-type">NCHAR</span>(<span class="hljs-number">50</span>);<br>#修改超级表标签名<br><span class="hljs-keyword">ALTER</span> STABLE userlocation CHANGE TAG testtag testtag1;<br>#修改超级表列宽<br><span class="hljs-keyword">ALTER</span> STABLE stb_name MODIFY TAG testtag1 <span class="hljs-type">NCHAR</span>(<span class="hljs-number">100</span>);<br>#删除超级表标签<br><span class="hljs-keyword">ALTER</span> STABLE userlocation <span class="hljs-keyword">DROP</span> TAG testtag1;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>使用 SELECT 语句可以完成在超级表上的投影及聚合两类查询，在 WHERE 语句中可以对标签及列进行筛选及过滤。</p>
<p>如果在超级表查询语句中不加 ORDER BY, 返回顺序是先返回一个子表的所有数据，然后再返回下个子表的所有数据，所以返回的数据是无序的。如果增加了 ORDER BY 语句，会严格按 ORDER BY 语句指定的顺序返回的。</p>
<p>除了更新标签的值的操作是针对子表进行，其他所有的标签操作（添加标签、删除标签等）均只能作用于 STable，不能对单个子表操作。对 STable 添加标签以后，依托于该 STable 建立的所有表将自动增加了一个标签，所有新增标签的默认值都是 NULL。</p>
</blockquote>
<p>开源版限制</p>
<p>1.mnode最多3个；</p>
<p>2.内存分配机制没有企业版控制的好；</p>
<p>内存OOM原因：</p>
<p> 剩余内存小于 vm.min_free_kbytes ；</p>
<p>程序请求的内存大于剩余内存；</p>
<p>内存充足但程序占用了特殊的内存地址。</p>
<h3 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h3><p>这里使用DATAX</p>
<p>☆ DATAX工具包必需使用官方提供，不然会出各种依赖包问题</p>
<p>亲测可用工具包下载地址：<a target="_blank" rel="noopener" href="https://cloud.189.cn/t/AVbmaqmUJRf2%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9Ae1jy%EF%BC%89">https://cloud.189.cn/t/AVbmaqmUJRf2（访问码：e1jy）</a></p>
<p>安装 datax后，此文默认DATAX_HOME:/opt/datax</p>
<p>迁移脚本放入 /datax/job文件夹内</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;job&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mysqlreader&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_service&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Lunz2017&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;querySql&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                  <span class="hljs-string">&quot;SELECT CONCAT(CONCAT(CONCAT(&#x27;t&#x27;,LoginName),&#x27;_&#x27;),DeviceIMEI) AS tbname,LocationTime,Lat,Lng,Speed,Address,LoginName,UserName,DeviceIMEI,DeviceModel,DeviceType FROM tb_userlocation WHERE LocationTime IS NOT NULL AND Lat IS NOT NULL AND Lng IS NOT NULL AND Speed IS NOT NULL AND Address IS NOT NULL AND LoginName IS NOT NULL AND UserName IS NOT NULLAND DeviceIMEI IS NOT NULL AND DeviceModel IS NOT NULL AND DeviceType IS NOT NULL;&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;jdbc:mysql://pc-bp1zip05gl1b1ga3veo.rwlb.rds.aliyuncs.com:3306/locationcenter&quot;</span><span class="hljs-punctuation">]</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span>     <br><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>       <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tdenginewriter&quot;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>           <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_service&quot;</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Lunz2017&quot;</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>               <span class="hljs-string">&quot;tbname&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;locationtime&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;lat&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;lng&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;speed&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;address&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;loginname&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;deviceimei&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;devicemodel&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-string">&quot;devicetype&quot;</span><br>             <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>               <span class="hljs-punctuation">&#123;</span><br>                 <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                   <span class="hljs-string">&quot;userlocation&quot;</span><br>                 <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                 <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:TAOS-RS://192.168.200.99:6041/locationcenter&quot;</span><span class="hljs-punctuation">,</span><br>                 <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:TAOS-RS://192.168.200.148:6041/locationcenter&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><br>             <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;batchSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span><br>           <span class="hljs-attr">&quot;ignoreTagsUnmatched&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>         <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;setting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;channel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;byte&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>执行迁移</p>
<p>数据使用DATAX迁移，速度较慢</p>
<p><strong>优化方式</strong></p>
<p><em><strong>速度控制：</strong></em></p>
<p>迁移 json脚本中直接设置</p>
<table>
<thead>
<tr>
<th>job.setting.speed.channel</th>
<th>总并发数</th>
</tr>
</thead>
<tbody><tr>
<td>job.setting.speed.record</td>
<td>总record限速</td>
</tr>
<tr>
<td>job.setting.speed.byte</td>
<td>总byte限速</td>
</tr>
<tr>
<td>core.transport.channel.speed.record</td>
<td>单个channel的record限速，默认值为10000（10000条/s）</td>
</tr>
<tr>
<td>core.transport.channel.speed.byte</td>
<td>单个channel的byte限速，默认值1024*1024（1M/s）</td>
</tr>
</tbody></table>
<p><strong>注意事项：</strong></p>
<ol>
<li>若配置了总record限速，则必须配置单个channel的record限速</li>
<li>若配置了总byte限速，则必须配置单个channe的byte限速</li>
<li>若配置了总record限速和总byte限速，channel并发数参数就会失效。因为配置了总record限速和总byte限速之后，实际channel并发数是通过计算得到的：</li>
</ol>
<p><strong>计算公式为:</strong></p>
<p>min(总byte限速/单个channle的byte限速，总record限速/单个channel的record限速)</p>
<p>配置示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;core&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;channel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;byte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span> <span class="hljs-comment">//单个channel byte限速1M/s</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;job&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;setting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;byte&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span> <span class="hljs-comment">//总byte限速5M/s</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        ...<br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><em><strong>内存调整</strong></em></p>
<p>当提升DataX Job内Channel并发数时，内存的占用会显著增加，因为DataX作为数据交换通道，在内存中会缓存较多的数据。例如Channel中会有一个Buffer，作为临时的数据交换的缓冲区，而在部分Reader和Writer的中，也会存在一些Buffer，为了防止OOM等错误，需调大JVM的堆内存。</p>
<p> 调整JVM xms xmx参数的两种方式：一种是直接更改datax.py脚本；另一种是在启动的时候，加上对应的参数，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">python /newdisk/soft/datax/bin/datax.py --jvm=&quot;-Xms6G -Xmx6G&quot; /newdisk/soft/datax/job/mysql2td_location.json<br></code></pre></td></tr></table></figure>

<ul>
<li><p>-Xms8G：运行的最小分配内存，如果可用内存不足5G，这个命令将不能被执行。</p>
</li>
<li><p>-Xmx8G：运行时最大占用内存大小。</p>
</li>
</ul>
<p>最终优化后json任务文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;job&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mysqlreader&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_service&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Lunz2017&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;splitPk&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Id&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;td_tablebane&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;LocationTime&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Lat&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Lng&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Speed&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;Address&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;LoginName&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;UserName&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;DeviceIMEI&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;DeviceModel&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-string">&quot;DeviceType&quot;</span><br>         <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;tb_userlocation_td3&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;jdbc:mysql://pc-bp1zip05gl1b1ga3veo.rwlb.rds.aliyuncs.com:3306/locationcenter&quot;</span><span class="hljs-punctuation">]</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tdenginewriter&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_service&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Lunz2017&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-string">&quot;tbname&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;locationtime&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;lat&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;lng&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;speed&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;address&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;loginname&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;username&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;deviceimei&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;devicemodel&quot;</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-string">&quot;devicetype&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>              <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                  <span class="hljs-string">&quot;userlocation&quot;</span><br>                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:TAOS-RS://192.168.200.99:6041/locationcenter&quot;</span><br>              <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;batchSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;ignoreTagsUnmatched&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;setting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;byte&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">15728640</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;core&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;transport&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;channel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;byte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5242880</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><em><strong>执行脚本</strong></em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">新建日志文档，记得定时清理，比较大</span><br>touch /opt/datax/log/mysql2td_location.log<br><span class="hljs-meta prompt_">#</span><span class="language-bash">后台执行迁移脚本，因数据量较大时间较久，为防止session断掉，后台运行</span><br>nohup python /opt/datax/bin/datax.py --jvm=&quot;-Xms5G -Xmx5G&quot; /opt/datax/job/mysql2td_location.json &gt;&gt; /opt/datax/log/mysql2td_location.log 2&gt;&amp;1 &amp;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看日志</span><br>tail -200f /opt/datax/log/mysql2td_location.log<br><span class="hljs-meta prompt_">#</span><span class="language-bash">日志太大了，不要日志</span><br>nohup python /newdisk/soft/datax/bin/datax.py --jvm=&quot;-Xms6G -Xmx6G&quot; /newdisk/soft/datax/job/mysql2td_location.json &gt;/dev/null 2&gt;log &amp;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">因为是后台运行 执行完毕需要杀掉进程</span><br>ps -ef|grep datax<br>kill pid<br></code></pre></td></tr></table></figure>

<h3 id="应用数据压测对比"><a href="#应用数据压测对比" class="headerlink" title="应用数据压测对比"></a>应用数据压测对比</h3><blockquote>
<p>测试数据：1.3亿条</p>
<p>存储格式：超级表加单表</p>
<p>服务器：双节点4C8G</p>
</blockquote>
<p>查询单人3天内所有定位点并按定位时间排序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">FROM</span> userlocation <br><span class="hljs-keyword">WHERE</span> locationtime <span class="hljs-operator">&gt;</span> now<span class="hljs-number">-750</span>d <br><span class="hljs-keyword">AND</span> loginname<span class="hljs-operator">=</span><span class="hljs-string">&#x27;ZR18080096&#x27;</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> locationtime <br>LIMIT <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>平均用时：Query OK, 10 row(s) in set (0.029506s)</p>
</blockquote>
<p>查询每个人最新一次定位</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">LAST</span>(<span class="hljs-operator">*</span>) <br><span class="hljs-keyword">FROM</span> userlocation <br><span class="hljs-keyword">WHERE</span> loginname<span class="hljs-operator">=</span><span class="hljs-string">&#x27;ZR18080096&#x27;</span>;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>平均用时：Query OK, 1 row(s) in set (0.004578s)</p>
</blockquote>
<p>使用<code>taosBenchmark</code>测试TD性能</p>
<p><font color=red>压测使用超级表时，经常会在WHERE条件里的需要筛选的字段，放在字段里不要放TAG内</font></p>
<ul>
<li>时序数据：存放于 vnode 里，由 data、head 和 last 三个文件组成，数据量大，查询量取决于应用场景。容许乱序写入，但暂时不支持删除操作，并且仅在 update 参数设置为 1 时允许更新操作。通过采用一个采集点一张表的模型，一个时间段的数据是连续存储，对单张表的写入是简单的追加操作，一次读，可以读到多条记录，这样保证对单个采集点的插入和查询操作，性能达到最优。</li>
<li>标签数据：存放于 vnode 里的 meta 文件，支持增删改查四个标准操作。数据量不大，有 N 张表，就有 N 条记录，因此可以全内存存储。如果标签过滤操作很多，查询将十分频繁，因此 TDengine 支持多核多线程并发查询。只要计算资源足够，即使有数千万张表，过滤结果能毫秒级返回。</li>
<li>元数据：存放于 mnode 里，包含系统节点、用户、DB、Table Schema 等信息，支持增删改查四个标准操作。这部分数据的量不大，可以全内存保存，而且由于客户端有缓存，查询量也不大。因此目前的设计虽是集中式存储管理，但不会构成性能瓶颈。</li>
</ul>
<p>工具介绍: <a target="_blank" rel="noopener" href="https://www.taosdata.com/docs/cn/v2.0/tools/taosbenchmark#cli">https://www.taosdata.com/docs/cn/v2.0/tools/taosbenchmark#cli</a></p>
<p>检测脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">touch /newdisk/soft/taosbenchmark/locationsearch.json<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;filetype&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;query&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;cfgdir&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/etc/taos&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;host&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;192.168.200.99&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;port&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6030</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user_service&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Lunz2017&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;confirm_parameter_prompt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;no&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;databases&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;locationcenter&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;query_times&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;query_mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;taosc&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;super_table_query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;stblname&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;userlocation&quot;</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;query_interval&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;threads&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;sqls&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>     <span class="hljs-punctuation">&#123;</span><br>       <span class="hljs-attr">&quot;sql&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SELECT * FROM xxxx WHERE locationtime &gt; now-750d AND loginname=&#x27;ZR18080096&#x27; ORDER BY locationtime LIMIT 1000;&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;sql&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;SELECT LAST(*) FROM xxxx WHERE loginname=&#x27;ZR18080096&#x27;;&quot;</span><br>       <span class="hljs-punctuation">&#125;</span> <br>     <span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>执行指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">taosdemo -f /newdisk/soft/taosbenchmark/locationsearch.json -o /newdisk/soft/taosbenchmark/locationsearch.txt<br></code></pre></td></tr></table></figure>

<p>第一次测试WHERE 筛选条件里不带loginname筛选</p>
<p>检测结果：</p>
<details>
  <summary>展开查看测试结果</summary>
  <pre><code class="hljs"> 
[06/23 11:25:29.826294] INFO: /newdisk/soft/taosbenchmark/locationsearch.json
&#123;
        "filetype":     "query",
        "cfgdir":       "/etc/taos",
        "host": "192.168.200.99",
        "port": 6030,
        "user": "user_service",
        "password":     "Lunz2017",
        "confirm_parameter_prompt":     "no",
        "databases":    "locationcenter",
        "query_times":  20,
        "query_mode":   "taosc",
        "super_table_query":    &#123;
                "stblname":     "userlocation",
                "query_interval":       0,
                "threads":      5,
                "sqls": [&#123;
                                "sql":  "SELECT * FROM xxxx WHERE locationtime > now-750d ORDER BY locationtime LIMIT 1000;"
                        &#125;, &#123;
                                "sql":  "SELECT LAST(*) FROM xxxx;"
                        &#125;]
        &#125;
&#125;
[06/23 11:25:29.942103] INFO: taos client version: 2.6.0.0
[06/23 11:25:29.985904] INFO: userlocation's childTblCount: 2204
[06/23 11:25:47.395394] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.3860s
[06/23 11:25:47.661997] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:17.6520s
[06/23 11:25:49.801203] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:19.7930s
[06/23 11:25:51.781808] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.7750s
[06/23 11:25:52.382326] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:22.3750s
[06/23 11:26:00.011229] INFO: thread[4] has currently completed queries: 1531, QPS:     51.030
[06/23 11:26:00.014133] INFO: thread[3] has currently completed queries: 1534, QPS:     51.125
[06/23 11:26:00.024295] INFO: thread[2] has currently completed queries: 1369, QPS:     45.609
[06/23 11:26:00.024452] INFO: thread[1] has currently completed queries: 1201, QPS:     40.011
[06/23 11:26:00.059128] INFO: thread[0] has currently completed queries: 1241, QPS:     41.294
[06/23 11:26:04.529191] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.1340s
[06/23 11:26:04.737206] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:17.0750s
[06/23 11:26:08.044346] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.2430s
[06/23 11:26:13.127916] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.3460s
[06/23 11:26:13.680380] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.2980s
[06/23 11:26:21.806175] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.2770s
[06/23 11:26:22.789503] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:18.0520s
[06/23 11:26:26.866865] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.8220s
[06/23 11:26:30.013590] INFO: thread[4] has currently completed queries: 3067, QPS:     51.113
[06/23 11:26:30.017715] INFO: thread[3] has currently completed queries: 3023, QPS:     50.377
[06/23 11:26:30.068283] INFO: thread[0] has currently completed queries: 2470, QPS:     41.124
[06/23 11:26:30.072142] INFO: thread[1] has currently completed queries: 2441, QPS:     40.639
[06/23 11:26:30.081825] INFO: thread[2] has currently completed queries: 2781, QPS:     46.294
[06/23 11:26:33.868119] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:20.7410s
[06/23 11:26:34.794845] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.1140s
[06/23 11:26:38.007910] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.2010s
[06/23 11:26:39.027625] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.2380s
[06/23 11:26:44.349937] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:17.4830s
[06/23 11:26:53.690002] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:19.8220s
[06/23 11:26:54.179681] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.1720s
[06/23 11:26:54.751370] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:19.9570s
[06/23 11:26:55.450360] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.4230s
[06/23 11:27:00.032487] INFO: thread[4] has currently completed queries: 4689, QPS:     52.087
[06/23 11:27:00.036375] INFO: thread[3] has currently completed queries: 4625, QPS:     51.373
[06/23 11:27:00.081331] INFO: thread[1] has currently completed queries: 3736, QPS:     41.477
[06/23 11:27:00.093663] INFO: thread[0] has currently completed queries: 3794, QPS:     42.115
[06/23 11:27:00.111722] INFO: thread[2] has currently completed queries: 4303, QPS:     47.756
[06/23 11:27:02.482377] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.1320s
[06/23 11:27:12.567807] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:18.3880s
[06/23 11:27:15.218884] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:19.7680s
[06/23 11:27:16.970065] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:23.2800s
[06/23 11:27:18.378608] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:23.6270s
[06/23 11:27:23.262542] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:20.7800s
[06/23 11:27:30.036647] INFO: thread[4] has currently completed queries: 6052, QPS:     50.422
[06/23 11:27:30.040622] INFO: thread[3] has currently completed queries: 5937, QPS:     49.462
[06/23 11:27:30.096812] INFO: thread[0] has currently completed queries: 4880, QPS:     40.636
[06/23 11:27:30.111611] INFO: thread[1] has currently completed queries: 4829, QPS:     40.207
[06/23 11:27:30.121808] INFO: thread[2] has currently completed queries: 5556, QPS:     46.256
[06/23 11:27:31.958135] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:19.3910s
[06/23 11:27:34.558165] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:19.3400s
[06/23 11:27:39.456386] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:22.4860s
[06/23 11:27:40.932419] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:22.5540s
[06/23 11:27:41.732982] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.4700s
[06/23 11:27:48.320896] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.3620s
[06/23 11:27:50.724743] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.1660s
[06/23 11:27:58.327522] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:16.5940s
[06/23 11:28:00.021201] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:20.5650s
[06/23 11:28:00.053498] INFO: thread[4] has currently completed queries: 7668, QPS:     51.105
[06/23 11:28:00.069814] INFO: thread[3] has currently completed queries: 7541, QPS:     50.253
[06/23 11:28:00.107871] INFO: thread[0] has currently completed queries: 6178, QPS:     41.159
[06/23 11:28:00.117358] INFO: thread[1] has currently completed queries: 6139, QPS:     40.897
[06/23 11:28:00.129142] INFO: thread[2] has currently completed queries: 7133, QPS:     47.515
[06/23 11:28:00.883925] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:19.9510s
[06/23 11:28:04.528633] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.2080s
[06/23 11:28:07.278929] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.5540s
[06/23 11:28:16.284883] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:17.9570s
[06/23 11:28:20.968207] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:20.9470s
[06/23 11:28:21.440716] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.9120s
[06/23 11:28:21.903253] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.0200s
[06/23 11:28:23.760206] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.4820s
[06/23 11:28:30.081073] INFO: thread[3] has currently completed queries: 9175, QPS:     50.952
[06/23 11:28:30.085854] INFO: thread[4] has currently completed queries: 9275, QPS:     51.506
[06/23 11:28:30.127840] INFO: thread[1] has currently completed queries: 7423, QPS:     41.211
[06/23 11:28:30.133642] INFO: thread[2] has currently completed queries: 8664, QPS:     48.100
[06/23 11:28:30.171622] INFO: thread[0] has currently completed queries: 7459, QPS:     41.401
[06/23 11:28:33.132875] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:16.8480s
[06/23 11:28:38.366290] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.9260s
[06/23 11:28:40.760953] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:17.0000s
[06/23 11:28:42.121350] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.1530s
[06/23 11:28:43.137537] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.2340s
[06/23 11:28:51.169437] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.0370s
[06/23 11:28:55.081240] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.7150s
[06/23 11:28:57.246965] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.4850s
[06/23 11:29:00.082296] INFO: thread[3] has currently completed queries: 10722, QPS:     51.039
[06/23 11:29:00.120325] INFO: thread[4] has currently completed queries: 10817, QPS:     51.482
[06/23 11:29:00.149787] INFO: thread[1] has currently completed queries: 8681, QPS:     41.310
[06/23 11:29:00.164720] INFO: thread[2] has currently completed queries: 10131, QPS:     48.207
[06/23 11:29:00.183676] INFO: thread[0] has currently completed queries: 8708, QPS:     41.432
[06/23 11:29:03.182366] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.0610s
[06/23 11:29:03.668377] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:20.5310s
[06/23 11:29:09.831966] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.6620s
[06/23 11:29:13.002151] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.9210s
[06/23 11:29:15.903543] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:18.6560s
[06/23 11:29:24.725181] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.5430s
[06/23 11:29:25.210472] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.5420s
[06/23 11:29:27.849301] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.0170s
[06/23 11:29:30.002702] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.0000s
[06/23 11:29:30.085149] INFO: thread[3] has currently completed queries: 12182, QPS:     50.742
[06/23 11:29:30.150275] INFO: thread[4] has currently completed queries: 12325, QPS:     51.324
[06/23 11:29:30.157143] INFO: thread[1] has currently completed queries: 9895, QPS:     41.203
[06/23 11:29:30.199164] INFO: thread[2] has currently completed queries: 11555, QPS:     48.108
[06/23 11:29:30.208238] INFO: thread[0] has currently completed queries: 9915, QPS:     41.278
[06/23 11:29:33.398296] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:17.4950s
[06/23 11:29:45.909740] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.0600s
[06/23 11:29:46.418577] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.6930s
[06/23 11:29:46.684370] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:21.4740s
[06/23 11:29:46.867443] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:16.8650s
[06/23 11:29:49.834367] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.4360s
[06/23 11:30:00.094313] INFO: thread[3] has currently completed queries: 13804, QPS:     51.110
[06/23 11:30:00.168550] INFO: thread[4] has currently completed queries: 13965, QPS:     51.692
[06/23 11:30:00.178332] INFO: thread[1] has currently completed queries: 11213, QPS:     41.503
[06/23 11:30:00.204815] INFO: thread[2] has currently completed queries: 13112, QPS:     48.528
[06/23 11:30:00.211187] INFO: thread[0] has currently completed queries: 11214, QPS:     41.502
[06/23 11:30:02.210162] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:15.3430s
[06/23 11:30:02.611121] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:16.7020s
[06/23 11:30:05.967470] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.1330s
[06/23 11:30:06.086602] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:19.6680s
[06/23 11:30:06.175547] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:19.4910s
[06/23 11:30:19.380477] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.1700s
[06/23 11:30:20.895797] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:18.2840s
[06/23 11:30:23.153220] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:17.1860s
[06/23 11:30:27.048434] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:20.8730s
[06/23 11:30:27.383756] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:21.2970s
[06/23 11:30:30.124032] INFO: thread[3] has currently completed queries: 15317, QPS:     51.037
[06/23 11:30:30.184927] INFO: thread[4] has currently completed queries: 15484, QPS:     51.583
[06/23 11:30:30.190163] INFO: thread[1] has currently completed queries: 12463, QPS:     41.518
[06/23 11:30:30.207185] INFO: thread[2] has currently completed queries: 14500, QPS:     48.301
[06/23 11:30:30.222273] INFO: thread[0] has currently completed queries: 12457, QPS:     41.493
[06/23 11:30:38.852287] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:19.4720s
[06/23 11:30:41.832871] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:20.9370s
[06/23 11:30:43.885670] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:20.7320s
[06/23 11:30:52.244190] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:25.1960s
[06/23 11:30:52.909152] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:25.5260s
[06/23 11:30:59.190679] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:20.3380s
[06/23 11:31:00.148485] INFO: thread[3] has currently completed queries: 16563, QPS:     50.170
[06/23 11:31:00.193099] INFO: thread[4] has currently completed queries: 16768, QPS:     50.784
[06/23 11:31:00.196303] INFO: thread[1] has currently completed queries: 13525, QPS:     40.961
[06/23 11:31:00.208392] INFO: thread[2] has currently completed queries: 15740, QPS:     47.668
[06/23 11:31:00.227029] INFO: thread[0] has currently completed queries: 13500, QPS:     40.882
[06/23 11:31:03.109165] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:21.2770s
[06/23 11:31:04.170431] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:20.2850s
[06/23 11:31:14.628583] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:22.3840s
[06/23 11:31:15.104783] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:22.1950s
[06/23 11:31:16.755738] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:17.5650s
[06/23 11:31:20.150011] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:17.0410s
[06/23 11:31:20.423057] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:16.2530s
[06/23 11:31:30.207574] INFO: thread[1] has currently completed queries: 14947, QPS:     41.496
[06/23 11:31:30.231212] INFO: thread[2] has currently completed queries: 17467, QPS:     48.489
[06/23 11:31:30.239761] INFO: thread[0] has currently completed queries: 14937, QPS:     41.465
[06/23 11:31:30.896999] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.2680s
[06/23 11:31:31.153452] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.0490s
[06/23 11:31:32.208711] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:12.0580s
[06/23 11:31:44.384336] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:13.4870s
[06/23 11:31:44.598594] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:13.4450s
[06/23 11:31:57.261829] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:12.8770s
[06/23 11:31:57.762974] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:13.1640s
[06/23 11:32:00.217199] INFO: thread[1] has currently completed queries: 16931, QPS:     43.389
[06/23 11:32:00.255773] INFO: thread[0] has currently completed queries: 16907, QPS:     43.324
[06/23 11:32:11.843653] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:14.5820s
[06/23 11:32:12.100391] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:14.3370s
[06/23 11:32:12.101175] INFO: Spend 402.0970 second completed total queries: 88160, the QPS of all threads:    219.251
    </code></pre>
</details>


<p>QPS大概是295</p>
<p>第二次测试为上面全部查询条件，带WHERE筛选</p>
<details>
  <summary>展开查看测试结果</summary>
  <pre><code class="hljs"> 
[06/23 15:56:16.741911] INFO: /newdisk/soft/taosbenchmark/locationsearch.json
&#123;
        "filetype":     "query",
        "cfgdir":       "/etc/taos",
        "host": "192.168.200.99",
        "port": 6030,
        "user": "user_service",
        "password":     "Lunz2017",
        "confirm_parameter_prompt":     "no",
        "databases":    "locationcenter",
        "query_times":  20,
        "query_mode":   "taosc",
        "super_table_query":    &#123;
                "stblname":     "userlocation",
                "query_interval":       0,
                "threads":      5,
                "sqls": [&#123;
                                "sql":  "SELECT * FROM xxxx WHERE locationtime > now-750d AND loginname='ZR18080096' ORDER BY locationtime LIMIT 1000;"
                        &#125;, &#123;
                                "sql":  "SELECT LAST(*) FROM xxxx WHERE loginname='ZR18080096';"
                        &#125;]
        &#125;
&#125;
[06/23 15:56:16.882414] INFO: taos client version: 2.6.0.0
[06/23 15:56:16.910498] INFO: userlocation's childTblCount: 2204
[06/23 15:56:29.610277] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.6770s
[06/23 15:56:29.851190] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.9170s
[06/23 15:56:30.948195] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:14.0150s
[06/23 15:56:33.864315] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.9320s
[06/23 15:56:34.081614] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:17.1500s
[06/23 15:56:42.131075] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.2800s
[06/23 15:56:42.348381] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.7380s
[06/23 15:56:45.165683] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:14.2170s
[06/23 15:56:46.935699] INFO: thread[0] has currently completed queries: 1582, QPS:     52.726
[06/23 15:56:46.941998] INFO: thread[3] has currently completed queries: 2098, QPS:     69.915
[06/23 15:56:46.949207] INFO: thread[1] has currently completed queries: 1561, QPS:     52.004
[06/23 15:56:46.964167] INFO: thread[4] has currently completed queries: 2083, QPS:     69.364
[06/23 15:56:46.965832] INFO: thread[2] has currently completed queries: 1889, QPS:     62.900
[06/23 15:56:50.149224] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.2850s
[06/23 15:56:50.215609] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.1340s
[06/23 15:56:54.128171] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:11.7800s
[06/23 15:56:54.502407] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.3710s
[06/23 15:56:58.316296] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.1510s
[06/23 15:57:06.099179] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.9500s
[06/23 15:57:06.300253] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.0850s
[06/23 15:57:06.536024] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.4080s
[06/23 15:57:06.668328] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.1660s
[06/23 15:57:11.682409] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.3660s
[06/23 15:57:16.957269] INFO: thread[3] has currently completed queries: 4237, QPS:     70.588
[06/23 15:57:16.969086] INFO: thread[4] has currently completed queries: 4220, QPS:     70.292
[06/23 15:57:16.970547] INFO: thread[0] has currently completed queries: 3227, QPS:     53.748
[06/23 15:57:16.973480] INFO: thread[1] has currently completed queries: 3215, QPS:     53.547
[06/23 15:57:16.985694] INFO: thread[2] has currently completed queries: 3767, QPS:     62.729
[06/23 15:57:19.170242] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.6340s
[06/23 15:57:19.243252] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.5750s
[06/23 15:57:22.138964] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.0390s
[06/23 15:57:22.268433] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.9680s
[06/23 15:57:25.518519] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.8360s
[06/23 15:57:31.449882] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.2790s
[06/23 15:57:31.857031] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.6140s
[06/23 15:57:37.294125] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.1550s
[06/23 15:57:37.499734] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.2310s
[06/23 15:57:38.831634] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.3130s
[06/23 15:57:44.038288] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.5890s
[06/23 15:57:44.764270] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.9070s
[06/23 15:57:46.961418] INFO: thread[3] has currently completed queries: 6376, QPS:     70.822
[06/23 15:57:46.974507] INFO: thread[0] has currently completed queries: 4943, QPS:     54.896
[06/23 15:57:46.976399] INFO: thread[4] has currently completed queries: 6343, QPS:     70.445
[06/23 15:57:46.980930] INFO: thread[1] has currently completed queries: 4943, QPS:     54.893
[06/23 15:57:46.992588] INFO: thread[2] has currently completed queries: 5799, QPS:     64.391
[06/23 15:57:52.125702] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.2940s
[06/23 15:57:53.080700] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.7860s
[06/23 15:57:53.433868] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.9340s
[06/23 15:57:56.327224] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:11.5630s
[06/23 15:57:56.615254] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.5770s
[06/23 15:58:05.933754] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.8080s
[06/23 15:58:09.475644] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:13.1480s
[06/23 15:58:09.672404] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.2390s
[06/23 15:58:09.914506] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.8340s
[06/23 15:58:09.956917] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:13.3410s
[06/23 15:58:16.966921] INFO: thread[3] has currently completed queries: 8454, QPS:     70.431
[06/23 15:58:16.977414] INFO: thread[0] has currently completed queries: 6587, QPS:     54.871
[06/23 15:58:16.990589] INFO: thread[1] has currently completed queries: 6565, QPS:     54.682
[06/23 15:58:17.000403] INFO: thread[2] has currently completed queries: 7772, QPS:     64.731
[06/23 15:58:17.001556] INFO: thread[4] has currently completed queries: 8453, QPS:     70.402
[06/23 15:58:19.212969] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.2790s
[06/23 15:58:21.579566] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.1040s
[06/23 15:58:21.933175] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:11.9760s
[06/23 15:58:25.113474] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.4410s
[06/23 15:58:25.959218] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.0450s
[06/23 15:58:33.001226] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.7880s
[06/23 15:58:34.034189] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.4550s
[06/23 15:58:34.435996] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.5020s
[06/23 15:58:41.647532] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.5340s
[06/23 15:58:42.139212] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.1800s
[06/23 15:58:46.983853] INFO: thread[0] has currently completed queries: 8220, QPS:     54.781
[06/23 15:58:46.987185] INFO: thread[3] has currently completed queries: 10563, QPS:     70.395
[06/23 15:58:47.005994] INFO: thread[2] has currently completed queries: 9694, QPS:     64.596
[06/23 15:58:47.017921] INFO: thread[1] has currently completed queries: 8197, QPS:     54.616
[06/23 15:58:47.019911] INFO: thread[4] has currently completed queries: 10543, QPS:     70.247
[06/23 15:58:47.106212] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:14.1050s
[06/23 15:58:47.251632] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.8150s
[06/23 15:58:47.281396] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:13.2470s
[06/23 15:58:57.020348] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.3730s
[06/23 15:58:57.287225] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.1480s
[06/23 15:58:59.345230] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.0640s
[06/23 15:58:59.431883] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.1800s
[06/23 15:59:00.536989] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.4300s
[06/23 15:59:11.005123] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:11.6600s
[06/23 15:59:11.162868] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:11.7310s
[06/23 15:59:12.037817] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.0170s
[06/23 15:59:12.621252] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.3340s
[06/23 15:59:13.415012] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:12.8780s
[06/23 15:59:16.996454] INFO: thread[0] has currently completed queries: 9981, QPS:     55.430
[06/23 15:59:17.022996] INFO: thread[4] has currently completed queries: 12739, QPS:     70.738
[06/23 15:59:17.024869] INFO: thread[3] has currently completed queries: 12735, QPS:     70.714
[06/23 15:59:17.042181] INFO: thread[1] has currently completed queries: 9931, QPS:     55.139
[06/23 15:59:17.079183] INFO: thread[2] has currently completed queries: 11653, QPS:     64.686
[06/23 15:59:23.204856] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.1990s
[06/23 15:59:23.588289] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.4260s
[06/23 15:59:26.897799] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.4820s
[06/23 15:59:27.305009] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.2680s
[06/23 15:59:27.927708] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.3060s
[06/23 15:59:35.304509] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.1000s
[06/23 15:59:36.224949] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.6360s
[06/23 15:59:40.658812] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.7610s
[06/23 15:59:43.117408] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.8120s
[06/23 15:59:43.584076] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:15.6570s
[06/23 15:59:46.998960] INFO: thread[0] has currently completed queries: 11670, QPS:     55.554
[06/23 15:59:47.026291] INFO: thread[4] has currently completed queries: 14896, QPS:     70.902
[06/23 15:59:47.035069] INFO: thread[3] has currently completed queries: 14879, QPS:     70.818
[06/23 15:59:47.055110] INFO: thread[1] has currently completed queries: 11631, QPS:     55.353
[06/23 15:59:47.117361] INFO: thread[2] has currently completed queries: 13581, QPS:     64.615
[06/23 15:59:47.813407] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.5090s
[06/23 15:59:48.530546] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.3050s
[06/23 15:59:54.360848] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.7020s
[06/23 15:59:59.613625] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:16.4960s
[06/23 16:00:00.209528] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:16.6250s
[06/23 16:00:00.379573] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.5660s
[06/23 16:00:01.540119] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:13.0100s
[06/23 16:00:07.864559] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.5040s
[06/23 16:00:12.572445] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:12.1930s
[06/23 16:00:13.713394] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:12.1730s
[06/23 16:00:15.147517] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:15.5340s
[06/23 16:00:15.204324] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:14.9950s
[06/23 16:00:17.001404] INFO: thread[0] has currently completed queries: 13332, QPS:     55.534
[06/23 16:00:17.031175] INFO: thread[4] has currently completed queries: 17047, QPS:     71.000
[06/23 16:00:17.041008] INFO: thread[3] has currently completed queries: 17005, QPS:     70.822
[06/23 16:00:17.057005] INFO: thread[1] has currently completed queries: 13331, QPS:     55.517
[06/23 16:00:17.129278] INFO: thread[2] has currently completed queries: 15597, QPS:     64.934
[06/23 16:00:20.918288] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:13.0540s
[06/23 16:00:24.169922] INFO: thread[4] complete all sqls to allocate all sub-tables[1764 - 2203] once queries duration:11.5970s
[06/23 16:00:24.723675] INFO: thread[3] complete all sqls to allocate all sub-tables[1323 - 1763] once queries duration:11.0100s
[06/23 16:00:29.377737] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:14.1730s
[06/23 16:00:29.435308] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:14.2880s
[06/23 16:00:31.775970] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:10.8570s
[06/23 16:00:41.958418] INFO: thread[2] complete all sqls to allocate all sub-tables[882 - 1322] once queries duration:10.1820s
[06/23 16:00:42.163680] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:12.7280s
[06/23 16:00:42.360845] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:12.9830s
[06/23 16:00:47.006939] INFO: thread[0] has currently completed queries: 15361, QPS:     56.877
[06/23 16:00:47.073863] INFO: thread[1] has currently completed queries: 15353, QPS:     56.833
[06/23 16:00:53.858526] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:11.6950s
[06/23 16:00:54.201840] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:11.8410s
[06/23 16:01:06.349354] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:12.1480s
[06/23 16:01:06.422182] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:12.5640s
[06/23 16:01:17.034805] INFO: thread[0] has currently completed queries: 17509, QPS:     58.343
[06/23 16:01:17.090599] INFO: thread[1] has currently completed queries: 17481, QPS:     58.239
[06/23 16:01:18.832644] INFO: thread[0] complete all sqls to allocate all sub-tables[0 - 440] once queries duration:12.4100s
[06/23 16:01:19.128519] INFO: thread[1] complete all sqls to allocate all sub-tables[441 - 881] once queries duration:12.7790s
[06/23 16:01:19.128796] INFO: Spend 302.1980 second completed total queries: 88160, the QPS of all threads:    291.729  
    </code></pre>
</details> 


<p>QPS影响不大，219</p>
<p>RDS测试使用mysql自带mysqlslap</p>
<p>并发、SQL语句保持与TD一致</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tb_userlocation_td3 <span class="hljs-keyword">WHERE</span> locationtime <span class="hljs-operator">&gt;</span> DATE_ADD(NOW(),<span class="hljs-type">INTERVAL</span> <span class="hljs-number">-750</span> <span class="hljs-keyword">DAY</span>) <span class="hljs-keyword">AND</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> locationtime LIMIT <span class="hljs-number">1000</span>;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tb_userlocation_td3 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> locationtime <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mysqlslap -hpc-bp1zip05gl1b1ga3v.rwlb.rds.aliyuncs.com --create-schema=locationcenter -uuser_service -pLunz2017 --number-of-queries=200 --iterations=5 --concurrency=200 --engine=innodb --query=/opt/userlocationslap.sql --verbose<br></code></pre></td></tr></table></figure>

<p>第一次压测结果，WHERE 条件中不加loginname筛选条件</p>
<details>
  <summary>展开查看测试结果</summary>
  <pre><code class="hljs">
Benchmark
        Running for engine innodb
        Average number of seconds to run all queries: 0.163 seconds
        Minimum number of seconds to run all queries: 0.141 seconds
        Maximum number of seconds to run all queries: 0.216 seconds
        Number of clients running queries: 5
        Average number of queries per client: 40  
    </code></pre>
</details>        


<p><img src="https://picwong.oss-cn-qingdao.aliyuncs.com/zr.wongcw/202206231714349.png" srcset="/img/loading.gif" lazyload alt="image-20220623171426893"></p>
<p>换算为QPS后，大概 235左右</p>
<p>第二次压测，SQL脚本为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tb_userlocation_td3 <span class="hljs-keyword">WHERE</span> locationtime <span class="hljs-operator">&gt;</span> DATE_ADD(NOW(),<span class="hljs-type">INTERVAL</span> <span class="hljs-number">-750</span> <span class="hljs-keyword">DAY</span>) <span class="hljs-keyword">AND</span> loginname<span class="hljs-operator">=</span><span class="hljs-string">&#x27;ZR18080096&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> locationtime LIMIT <span class="hljs-number">1000</span>;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> tb_userlocation_td3 <span class="hljs-keyword">WHERE</span> loginname<span class="hljs-operator">=</span><span class="hljs-string">&#x27;ZR18080096&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> locationtime <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>

<p>这样压测，RDS直接挂了，没结果。</p>
<p>RDS测试使用sysbench</p>
<p>工具优点是测试项全面，</p>
<p>安装工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install sysbench<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果没有此包就安装三方源后再执行</span><br>yum -y install epel-release<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看版本</span><br>sysbench --version<br></code></pre></td></tr></table></figure>

<p>因工具不能指定查询语句，只能添加测试表测试了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">准备测试脚本</span><br>mysqladmin -hpc-bp1zip05gl1b1ga3v.rwlb.rds.aliyuncs.com -uuser_service -pLunz2017 -P3306 create sbtest;<br><br>sysbench --mysql-host=pc-bp1zip05gl1b1ga3v.rwlb.rds.aliyuncs.com \<br>         --mysql-port=3306 \<br>         --mysql-user=user_service \<br>         --mysql-password=Lunz2017 \<br>         --mysql-db=locationcenter \<br>         /usr/share/sysbench/oltp_common.lua \<br>         --tables=10 \<br>         --table_size=100000 \<br>         prepare<br><span class="hljs-meta prompt_">#</span><span class="language-bash">压测脚本</span><br>sysbench --db-driver=mysql --time=30 --threads=5 --report-interval=1 \<br>         --mysql-host=pc-bp1zip05gl1b1ga3v.rwlb.rds.aliyuncs.com \<br>         --mysql-port=3306 \<br>         --mysql-user=user_service \<br>         --mysql-password=Lunz2017 \<br>         --mysql-db=locationcenter --tables=10 --table_size=1000000 \<br>         /usr/share/sysbench/oltp_point_select.lua \<br>         --db-ps-mode=disable run<br><span class="hljs-meta prompt_">#</span><span class="language-bash">清理测试数据</span><br>sysbench --db-driver=mysql --time=30 --threads=5 --report-interval=1 \<br>         --mysql-host=pc-bp1zip05gl1b1ga3v.rwlb.rds.aliyuncs.com \<br>         --mysql-port=3306 \<br>         --mysql-user=user_service \<br>         --mysql-password=Lunz2017 \<br>         --mysql-db=locationcenter --tables=10 --table_size=1000000 \<br>         oltp_read_only --db-ps-mode=disable cleanup<br></code></pre></td></tr></table></figure>

<p>压测结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs log">SQL statistics:<br>    queries performed:<br>        read:                            429542<br>        write:                           0<br>        other:                           0<br>        total:                           429542<br>    transactions:                        429542 (14316.25 per sec.)<br>    queries:                             429542 (14316.25 per sec.)<br>    ignored errors:                      0      (0.00 per sec.)<br>    reconnects:                          0      (0.00 per sec.)<br>General statistics:<br>    total time:                          30.0025s<br>    total number of events:              429542<br>Latency (ms):<br>         min:                                    0.23<br>         avg:                                    0.35<br>         max:                                   42.47<br>         95th percentile:                        0.43<br>         sum:                               149842.12<br>Threads fairness:<br>    events (avg/stddev):           85908.4000/2960.38<br>    execution time (avg/stddev):   29.9684/0.00<br></code></pre></td></tr></table></figure>



<h2 id="应用2-三方监控"><a href="#应用2-三方监控" class="headerlink" title="应用2 三方监控"></a>应用2 三方监控</h2><p>StatsD监控网络，collectd监控服务器硬件，配合garfna前台展示，均使用TDengine存储数据</p>
<h3 id="安装grafana监控"><a href="#安装grafana监控" class="headerlink" title="安装grafana监控"></a>安装grafana监控</h3><p>安装包下载地址：<a target="_blank" rel="noopener" href="https://cloud.189.cn/t/7bUb2eBRfM7f%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9A4bdl%EF%BC%89">https://cloud.189.cn/t/7bUb2eBRfM7f（访问码：4bdl）</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum install grafana-8.5.3-1.x86_64.rpm<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看cli版本</span>  <br>grafana-cli -V<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装td插件</span><br>sudo -u grafana grafana-cli \<br>  --pluginUrl https://github.com/taosdata/grafanaplugin/releases/download/v3.1.3/tdengine-datasource-3.1.3.zip \<br>  plugins install tdengine-datasource<br><span class="hljs-meta prompt_">#</span><span class="language-bash">编辑配置文件</span><br>/etc/grafana/grafana.ini<br>[plugins]<br>allow_loading_unsigned_plugins = tdengine-datasource<br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>sudo systemctl restart grafana-server<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果启动失败，就执行下这个</span><br>yum install polkit -y<br></code></pre></td></tr></table></figure>

<p>配合TDinsight监控数据库<br>配置及监控项解释： <a target="_blank" rel="noopener" href="https://docs.taosdata.com/reference/tdinsight/">https://docs.taosdata.com/reference/tdinsight/</a><br>监控脚本下载地址（内网机器可能加载不了脚本，json格式上传）：<a target="_blank" rel="noopener" href="https://cloud.189.cn/t/nQrEJzAvmiYj%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9Ab3ea%EF%BC%89">https://cloud.189.cn/t/nQrEJzAvmiYj（访问码：b3ea）</a></p>
<h3 id="StatsD安装"><a href="#StatsD安装" class="headerlink" title="StatsD安装"></a>StatsD安装</h3><p>下载安装包</p>
<p><a target="_blank" rel="noopener" href="https://github.com/statsd/statsd">https://github.com/statsd/statsd</a></p>
<p>云：<a target="_blank" rel="noopener" href="https://cloud.189.cn/t/AFnEzuAfENVb%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9A9els%EF%BC%89">https://cloud.189.cn/t/AFnEzuAfENVb（访问码：9els）</a></p>
<p>安装nodejs</p>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/en/download">https://nodejs.org/en/download</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">解压</span><br>xz -d node-xxxx.tar.xz<br>tar -xvf node-xxxx.tar<br><span class="hljs-meta prompt_">#</span><span class="language-bash">移动到文件夹</span><br>mv node-xxx /usr/local/node<br><span class="hljs-meta prompt_">#</span><span class="language-bash">建立软连接</span><br>ln -s /usr/local/node/bin/node /usr/bin/node<br>ln -s /usr/local/node/bin/npm /usr/bin/npm<br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证环境变量</span><br>node -v<br>npm -v<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置安装路径</span><br>cd /usr/local/node/<br>mkdir -p node_global<br>mkdir -p node_cache<br>npm config set prefix &quot;node_global&quot;<br>npm config set cache &quot;node_cache&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">npm慢的话装个cnmp</span><br>npm install cnpm -g --registry=https://registry.npm.taobao.org<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装依赖</span><br>npm install<br></code></pre></td></tr></table></figure>

<p>建账号、库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> user_mo PASS <span class="hljs-string">&#x27;Lunz2017&#x27;</span>;<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> user_mo PRIVILEGE write;<br><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> statsd <span class="hljs-keyword">UPDATE</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> collectd <span class="hljs-keyword">UPDATE</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> telegraf <span class="hljs-keyword">UPDATE</span> <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<p>编辑TD配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shel">vim /etc/taos/taosadapter.toml<br><br>[statsd]<br>enable = true<br>port = 6044<br>db = &quot;statsd&quot;<br>user = &quot;user_mo&quot;<br>password = &quot;Lunz2017&quot;<br>worker = 10<br>gatherInterval = &quot;5s&quot;<br>protocol = &quot;udp&quot;<br>maxTCPConnections = 250<br>tcpKeepAlive = false<br>allowPendingMessages = 50000<br>deleteCounters = true<br>deleteGauges = true<br>deleteSets = true<br>deleteTimings = true<br></code></pre></td></tr></table></figure>

<p>编辑statd配置文件，假设文件夹位置 /opt/statsd</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd  /opt/statsd<br>cp exampleConfig.js tdconfig.js<br>vim /opt/statsd/tdconfig.js<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br><span class="hljs-attr">port</span>: <span class="hljs-number">8125</span><br>, <span class="hljs-attr">backends</span>: [<span class="hljs-string">&quot;./backends/repeater&quot;</span>]<br>, <span class="hljs-attr">repeater</span>: [&#123; <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;192.168.200.99&#x27;</span>, <span class="hljs-attr">port</span>: <span class="hljs-number">6044</span>&#125;]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">node stats.js tdconfig.js &amp;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install nc<br>echo &quot;foo:1|c&quot; | nc -u -w1 192.168.200.99 8125<br></code></pre></td></tr></table></figure>



<h3 id="collectd-安装"><a href="#collectd-安装" class="headerlink" title="collectd 安装"></a>collectd 安装</h3><p>下载安装包</p>
<p><a target="_blank" rel="noopener" href="https://cloud.189.cn/t/bM3eAzAjQv2y%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9A4mew%EF%BC%89">https://cloud.189.cn/t/bM3eAzAjQv2y（访问码：4mew）</a></p>
<p>编译安装 略</p>
<p>配置接收直接采集插件数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /opt/collectd/etc/collectd.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">td官方文档默认编译安装位置 /etc/collectd/collectd.conf  验证非此文件</span><br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs conf">LoadPlugin network<br>&lt;Plugin network&gt;<br>         Server &quot;192.168.200.99&quot; &quot;6045&quot;<br>&lt;/Plugin&gt;<br></code></pre></td></tr></table></figure>

<p>配置write_tsdb 插件数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /opt/collectd/etc/collectd.conf<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs conf">LoadPlugin write_tsdb<br>&lt;Plugin write_tsdb&gt;<br>        &lt;Node&gt;<br>                Host &quot;192.168.200.99&quot;<br>                Port &quot;6047&quot;<br>                HostTags &quot;status=production&quot;<br>                StoreRates false<br>                AlwaysAppendDS false<br>        &lt;/Node&gt;<br>&lt;/Plugin&gt;<br></code></pre></td></tr></table></figure>

<p>编辑配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/taos/taosadapter.toml<br></code></pre></td></tr></table></figure>

<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-section">[opentsdb_telnet]</span><br><span class="hljs-attr">enable</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">maxTCPConnections</span> = <span class="hljs-number">250</span><br><span class="hljs-attr">tcpKeepAlive</span> = <span class="hljs-literal">false</span><br><span class="hljs-attr">dbs</span> = [<span class="hljs-string">&quot;opentsdb_telnet&quot;</span>, <span class="hljs-string">&quot;collectd&quot;</span>, <span class="hljs-string">&quot;icinga2&quot;</span>, <span class="hljs-string">&quot;tcollector&quot;</span>]<br><span class="hljs-attr">ports</span> = [<span class="hljs-number">6046</span>, <span class="hljs-number">6047</span>, <span class="hljs-number">6048</span>, <span class="hljs-number">6049</span>]<br><span class="hljs-attr">user</span> = <span class="hljs-string">&quot;user_mo&quot;</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">&quot;Lunz2017&quot;</span><br></code></pre></td></tr></table></figure>

<p>建立服务软连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">环境变量</span><br>ln -s /opt/collectd/sbin/collectd /usr/sbin/collectd<br><span class="hljs-meta prompt_">#</span><span class="language-bash">注册服务 这玩意不好使直接去库里验证数据吧</span><br>ln -s /opt/collectd/sbin/collectd /etc/init.d/collectd<br></code></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">collectd<br>ps -ef|grep collectd<br></code></pre></td></tr></table></figure>

<p>连接数据库查看collectd库内数据</p>
<p>验证存入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">use collectd;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> cpu_value limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>



<h2 id="应用3-另一种监控"><a href="#应用3-另一种监控" class="headerlink" title="应用3 另一种监控"></a>应用3 另一种监控</h2><p>安装 Telegraf 监控系统</p>
<p>添加镜像源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/influxdata.repo<br>[influxdata]<br>name = InfluxData Repository - Stable<br>baseurl = https://repos.influxdata.com/stable/\$basearch/main<br>enabled = 1<br>gpgcheck = 1<br>gpgkey = https://repos.influxdata.com/influxdb.key<br>EOF<br></code></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo yum install telegraf<br></code></pre></td></tr></table></figure>

<p>rpm安装：</p>
<p><a target="_blank" rel="noopener" href="https://cloud.189.cn/t/NZVVjaiYrYve%EF%BC%88%E8%AE%BF%E9%97%AE%E7%A0%81%EF%BC%9Ait2m%EF%BC%89">https://cloud.189.cn/t/NZVVjaiYrYve（访问码：it2m）</a></p>
<p>修改配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/etc/telegraf/telegraf.conf<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs conf">[[outputs.http]]<br>  url = &quot;http://192.168.200.99:6041/influxdb/v1/write?db=telegraf&quot;<br>  method = &quot;POST&quot;<br>  timeout = &quot;5s&quot;<br>  username = &quot;user_mo&quot;<br>  password = &quot;Lunz2017&quot;<br>  data_format = &quot;influx&quot;<br>  influx_max_line_bytes = 250<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo systemctl restart telegraf<br></code></pre></td></tr></table></figure>

<p>验证存入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">use telegraf;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> cpu limit <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>






                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="category-chain-item">数据库</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/TDEngine/" class="category-chain-item">TDEngine</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/TDEngine/">#TDEngine</a>
      
        <a href="/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/">#时序数据库</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>TDEngine应用测试</div>
      <div>https://blog.wongcw.cn/2022/06/02/TDEngine应用测试/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>wangcw</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年6月2日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'redgreat/redgreat.github.io');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <script>document.write("Copyright © wangcw 2020-" + new Date().getFullYear() + " All Rights Reserved") </script> <i class="iconfont icon-love"></i> <span id="timeDate"></span> <span id="times"></span> <script> var now = new Date(); function createtime() {  var grt= new Date("01/01/2022 00:00:00"); new Date().setTime(new Date().getTime()+250);  days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);  hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);  if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);  mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}  seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);  snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}  document.getElementById("timeDate").innerHTML = "本站已各种夹缝中安全运行 "+dnum+" 天 ";  document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; } setInterval("createtime()",250) </script> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      鲁ICP备2022020665号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="/js/xiantiao.js"></script>
<script src="/js/xiaoxuehua.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
